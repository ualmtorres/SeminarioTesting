<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.8.dev">
<meta name="author" content="Servicio de las Tecnologías de la Información y las Comunicaciones - Universidad de Almería">
<title>Testing (tutorial en curso)</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-right">
<div id="header">
<h1>Testing (tutorial en curso)</h1>
<div class="details">
<span id="author" class="author">Servicio de las Tecnologías de la Información y las Comunicaciones - Universidad de Almería</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Tabla de contenidos</div>
<ul class="sectlevel1">
<li><a href="#trueresumen">Resumen</a></li>
<li><a href="#trueintroducción">1. Introducción</a></li>
<li><a href="#truehola-mundo">2. Hola mundo</a>
<ul class="sectlevel2">
<li><a href="#truela-función-it">2.1. La función <code>it</code></a></li>
<li><a href="#trueagrupación-de-tests">2.2. Agrupación de tests</a></li>
</ul>
</li>
<li><a href="#truetests-unitarios">3. Tests unitarios</a>
<ul class="sectlevel2">
<li><a href="#truela-kata-fizz-buzz">3.1. La kata Fizz Buzz</a></li>
</ul>
</li>
<li><a href="#truecobertura-de-tests">4. Cobertura de tests</a>
<ul class="sectlevel2">
<li><a href="#trueexclusión-de-archivos-de-la-cobertura-de-tests">4.1. Exclusión de archivos de la cobertura de tests</a></li>
</ul>
</li>
<li><a href="#truetests-de-integración">5. Tests de integración</a>
<ul class="sectlevel2">
<li><a href="#truebdd">5.1. BDD</a></li>
</ul>
</li>
<li><a href="#truecaso-de-uso-catálogo-de-productos">6. Caso de uso. Catálogo de productos</a>
<ul class="sectlevel2">
<li><a href="#trueprimeros-tests">6.1. Primeros tests</a></li>
<li><a href="#truetests-del-controlador">6.2. Tests del controlador</a>
<ul class="sectlevel3">
<li><a href="#trueprimer-paso-evitar-que-falle-el-test">6.2.1. Primer paso. Evitar que falle el test</a></li>
<li><a href="#truesegundo-paso-añadir-tests">6.2.2. Segundo paso. Añadir tests</a></li>
<li><a href="#truetercer-paso-llevar-el-mock-del-servicio-a-una-clase">6.2.3. Tercer paso. Llevar el mock del servicio a una clase</a></li>
</ul>
</li>
<li><a href="#truetests-del-servicio">6.3. Tests del servicio</a>
<ul class="sectlevel3">
<li><a href="#trueprimer-paso-evitar-que-falle-el-test-2">6.3.1. Primer paso. Evitar que falle el test</a></li>
<li><a href="#truesegundo-paso-añadir-tests-2">6.3.2. Segundo paso. Añadir tests</a></li>
<li><a href="#truetercer-paso-llevar-el-mock-del-repositorio-a-una-clase">6.3.3. Tercer paso. Llevar el mock del repositorio a una clase</a></li>
</ul>
</li>
<li><a href="#truetests-end-to-end">6.4. Tests end to end</a>
<ul class="sectlevel3">
<li><a href="#trueañadir-script-para-tests-e2e-en-modo-watch">6.4.1. Añadir script para tests e2e en modo <code>watch</code></a></li>
<li><a href="#trueprimer-paso-evitar-que-falle-el-test-3">6.4.2. Primer paso. Evitar que falle el test</a></li>
<li><a href="#truesegundo-paso-añadir-tests-3">6.4.3. Segundo paso. Añadir tests</a></li>
</ul>
</li>
<li><a href="#truecobertura-de-tests-2">6.5. Cobertura de tests</a>
<ul class="sectlevel3">
<li><a href="#trueignorando-los-módulos-para-el-análisis-de-la-cobertura">6.5.1. Ignorando los módulos para el análisis de la cobertura</a></li>
<li><a href="#trueanálisis-de-la-cobertura">6.5.2. Análisis de la cobertura</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#trueanexo-i-configuración-inicial-del-proyecto">Anexo I. Configuración inicial del proyecto</a>
<ul class="sectlevel2">
<li><a href="#truecreación-de-la-entidad">Creación de la entidad</a></li>
<li><a href="#trueconfiguración-de-typeorm">Configuración de TypeORM</a></li>
<li><a href="#trueconfiguración-de-swagger">Configuración de Swagger</a></li>
<li><a href="#truedtos">DTOs</a></li>
<li><a href="#trueimplementación-de-los-métodos-del-servicio">Implementación de los métodos del servicio</a></li>
<li><a href="#trueadaptación-de-los-parámetros-del-controlador">Adaptación de los parámetros del controlador</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/logocloudstic.png" alt="logocloudstic">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueresumen"><a class="anchor" href="#trueresumen"></a>Resumen</h2>
<div class="sectionbody">
<div class="ulist">
<div class="title">Objetivos</div>
<ul>
<li>
<p>Introducir el proceso de testing en backend.</p>
</li>
<li>
<p>Crear tests unitarios y de integración de aplicaciones NestJS con Jest.</p>
</li>
<li>
<p>Aprender a agrupar tests en suites de tests.</p>
</li>
<li>
<p>Conocer la importancia de la cobertura de tests.</p>
</li>
<li>
<p>Realizar los tests unitarios de controladores y servicios en una API REST.</p>
</li>
<li>
<p>Utilizar mocks de servicios y de repositorios para la realización de tests unitarios.</p>
</li>
<li>
<p>Usar mocks de función y mocks de clases.</p>
</li>
<li>
<p>Realizar tests de integración.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Disponible los repositorios usados en este tutorial.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/ualmtorres/fizzbuzz">Fizz Buzz</a></p>
</li>
<li>
<p><a href="https://github.com/ualmtorres/testing-product-catalog/tree/base">Base del caso de uso del catálogdo de productos (Rama <code>base</code>)</a></p>
</li>
<li>
<p><a href="https://github.com/ualmtorres/testing-product-catalog/tree/master">Caso de uso del catálogo de productos (en curso)</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueintroducción"><a class="anchor" href="#trueintroducción"></a>1. Introducción</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Proceso necesario en cualquier proyecto software serio.</p>
</li>
<li>
<p>Un test es un código que comprueba tu código. Hacen tener más confianza en la aplicación. Previenen arreglar una cosa sin romper otra. Queremos que ni nuestro yo del futuro ni otras personas rompan el código que hemos escrito hoy.</p>
</li>
<li>
<p>La automatización de tests facilita la repetición de tests o suites de test de forma rápida y sencilla durante el desarrollo.</p>
</li>
<li>
<p>Da un feedback inmediato a los desarrolladores.</p>
</li>
<li>
<p>Facilita la refactorización chequeando el funcionamiento correcto del código refactorizado.</p>
</li>
<li>
<p>Permite la reproducción de casos complejos (fallos a ciertas horas, desde ciertos sitios, &#8230;&#8203;)</p>
</li>
<li>
<p>Uso de sistemas de CI que permiten la creación de pipelines que permiten la ejecución automatizada de tests, creación del build, despliegue automatizado o manual, &#8230;&#8203;</p>
</li>
<li>
<p>Tipos de testing</p>
<div class="ulist">
<ul>
<li>
<p>Tests unitarios. Son código que ayuda a asegurar que las partes de las aplicaciones funcionan de la forma esperada. La unidad testada puede ser una función, una clase, un módulo. Deben ser independientes unos de otros. Para una entrada, el test unitario comprueba el resultado. No contactan con el mundo exterior</p>
</li>
<li>
<p>Tests de integración. Comprobamos la integración de nuestro sistema con algo de infraestructura (p.e. bases de datos, archivos, E/S, &#8230;&#8203;). Hacen llamadas a servicios externos.</p>
</li>
<li>
<p>Tests end to end. Simulan condiciones reales. Se ejecutarían en un navegador (o similar). Simulan a un usuario en la aplicación (escribiendo, haciendo clics, &#8230;&#8203;)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/piramide-testing.png" alt="piramide testing">
</div>
</div>
<div class="paragraph">
<p>La pirámide de tests, además de representar el coste y la velocidad de ejecucuión de los tests, también refleja que deberíamos escribir más tests de los simples (unitarios) y menos tests de los complejos (end-to-end).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El código de los tests tiene que ser fácil de mantener y tiene que centrarse en el resultado del método probado. Después de crear un test nos debemos preguntar lo siguiente: si un día se refactoriza el método probado (sin cambiar su resultado), ¿tendré que cambiar el test? Si la respuesta es sí, hay que modificar el test. Posiblemente en el test nos estemos centrando en detalles del proceso que no deberían de estar en el test.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>NestJS ayuda para que el proceso sea menos tedioso.</p>
<div class="ulist">
<ul>
<li>
<p>Scaffolding para tests en la aplicación.</p>
</li>
<li>
<p>Integracion con <a href="https://github.com/facebook/jest">Jest</a> (desarrollado por Facebook y se usa con "cero configuración") y <a href="https://github.com/visionmedia/supertest">Supertest</a> (para testing de peticiones HTTP). No obstante, se puede usar cualquier otro framework de testing.</p>
</li>
<li>
<p>Uso del sistema de inyección de dependencias de NestJS para facilitar el uso de mocks.</p>
</li>
<li>
<p>Jest configurado en <code>package.json</code> determinando mediante expresiones regulares los archivos que se consideran tests (p.e. para que las pruebas estuviesen en cualquier archivo <code>.spec.ts</code> usaríamos <code>"testRegex": ".*\\.spec\\.ts$"</code>).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truehola-mundo"><a class="anchor" href="#truehola-mundo"></a>2. Hola mundo</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Crearemos un proyecto de ejemplo para la <a href="https://kata-log.rocks/fizz-buzz-kata">kata Fizz Buzz</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ nest new fizzbuzz</code></pre>
</div>
</div>
<div class="paragraph">
<p>Al crear un proyecto nuevo, NestJS instala las dependencias para testing y crea una suite de pruebas con un test de ejemplo para probar que la llamada a <code>/</code> devuelve <code>Hello World!</code>.</p>
</div>
<div class="paragraph">
<p>Comenzamos probando el código de ejemplo creado por NestJS.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ cd fizzbuzz
$ npm run test</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">El resultado es el siguiente y nos informa que se han pasado los tests con éxito.

 PASS  src/app.controller.spec.ts
  AppController
    root
      ✓ should return "Hello World!" (14 ms)

Test Suites: 1 passed, 1 total
Tests:       1 passed, 1 total
Snapshots:   0 total
Time:        4.162 s
Ran all test suites.</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="truela-función-it"><a class="anchor" href="#truela-función-it"></a>2.1. La función <code>it</code></h3>
<div class="ulist">
<ul>
<li>
<p>Tests implementados en funciones <code>it</code> o <code>test</code>.</p>
</li>
<li>
<p>Toma 3 argumentos (nombre del test, función con las expectativas y timeout, este último opcional). El timeout predeterminado es de 5 segundos.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">it('should return "Hello World!"', () =&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
  expect(appController.getHello()).toBe('Hello World!'); <i class="conum" data-value="2"></i><b>(2)</b>
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>El usar <code>it</code> en lugar de <code>test</code>, sumado a usar el nombre del test en condicional, hace el test más legible: <code>it should return "Hello World!</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>expect</code> se usar para comprobar un valor obtenido por una <a href="https://jestjs.io/docs/expect">función matcher</a>, como <code>toBe</code>.</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="trueagrupación-de-tests"><a class="anchor" href="#trueagrupación-de-tests"></a>2.2. Agrupación de tests</h3>
<div class="paragraph">
<p>Para tener un código de testing más limpio y organizado se pueden incluir los tests (<code>it</code>) en la función <code>describe</code>. Esto genera un bloque formado por varios tests. Además, los bloques <code>describe</code> se pueden anidar</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">  describe('root', () =&gt; {
    it('should return "Hello World!"', () =&gt; {
      expect(appController.getHello()).toBe('Hello World!');
    });
  });</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truetests-unitarios"><a class="anchor" href="#truetests-unitarios"></a>3. Tests unitarios</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="truela-kata-fizz-buzz"><a class="anchor" href="#truela-kata-fizz-buzz"></a>3.1. La kata Fizz Buzz</h3>
<div class="paragraph">
<p>Haremos los tests unitarios usando la <a href="https://kata-log.rocks/fizz-buzz-kata">kata Fizz Buzz</a>. Seguiremos estos pasos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crearemos un nuevo módulo, servicio y controlador para la kata.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">nest g module fizzbuzz
nest g service fizzbuzz
nest g controller fizzbuzz</code></pre>
</div>
</div>
</li>
<li>
<p><em>El servicio</em>. Crearemos un nuevo método en <code>fizzbuzz/fizzbuzz.service.ts</code> denominado <code>fizzbuzz</code> que aceptará un argumento de tipo <code>number</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="typescript" class="language-typescript hljs">import { Injectable } from '@nestjs/common';

@Injectable()
export class FizzbuzzService { <i class="conum" data-value="1"></i><b>(1)</b>
  fizzbuzz(number): any {
    if (number &lt; 1 || number &gt; 100) {
      return;
    }

    if (number % 15 === 0) {
      return 'FizzBuzz';
    }

    if (number % 3 === 0) {
      return 'Fizz';
    }

    if (number % 5 === 0) {
      return 'Buzz';
    }

    return number;
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Método que implementa la kata Fizz Buzz</td>
</tr>
</table>
</div>
</li>
<li>
<p><em>El controlador</em>. Crearemos un endpoint en <code>fizzbuzz/fizzbuzz.controller.ts</code> que acepte un número como parámetro. Este endpoint llamará al método del servicio del paso anterior.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Controller, Get, Param } from '@nestjs/common';
import { FizzbuzzService } from './fizzbuzz.service';

@Controller('fizzbuzz')
export class FizzbuzzController {
  constructor(private fizzbuzzService: FizzbuzzService) {}

  @Get(':number') <i class="conum" data-value="1"></i><b>(1)</b>
  fizzbuzz(@Param('number') number): any {
    return this.fizzbuzzService.fizzbuzz(number);
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nueva ruta para la kata Fizz Buzz</td>
</tr>
</table>
</div>
</li>
<li>
<p><em>Los tests</em>. Añadiremos los tests en el grupo <code>describe</code> existente en <code>fizzbuzz/fizzbuzz.service.spec.ts</code></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Test, TestingModule } from '@nestjs/testing';
import { FizzbuzzService } from './fizzbuzz.service';

describe('FizzbuzzService', () =&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
  let service: FizzbuzzService;

  beforeEach(async () =&gt; {
    const module: TestingModule = await Test.createTestingModule({
      providers: [FizzbuzzService],
    }).compile();

    service = module.get&lt;FizzbuzzService&gt;(FizzbuzzService);
  });

  it('should be defined', () =&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
    expect(service).toBeDefined();
  });

  it('should return Fizz when the number is multiple of 3', () =&gt; { <i class="conum" data-value="3"></i><b>(3)</b>
    expect(service.fizzbuzz(3)).toBe('Fizz'); <i class="conum" data-value="4"></i><b>(4)</b>
  });

  it('should return Buzz when the number is multiple of 5', () =&gt; {
    expect(service.fizzbuzz(5)).toBe('Buzz');
  });

  it('should return FizzBuzz when the number is multiple of 15', () =&gt; {
    expect(service.fizzbuzz(15)).toBe('FizzBuzz');
  });

  it('should return the number when then number is neither multiple of 3, 5 nor 15', () =&gt; {
    expect(service.fizzbuzz(2)).toBe(2);
  });

  it('should return nothing when the number is not between 1 and 100', () =&gt; { <i class="conum" data-value="5"></i><b>(5)</b>
    expect(service.fizzbuzz(0)).toBe(undefined);
    expect(service.fizzbuzz(101)).toBe(undefined);
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Grupo de tests creados inicialmente por NestJS a modo de ejemplo para el servicio Fizzbuzz</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Test inicial creado por NestJS</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Cada test va en su <code>it</code> (o <code>test</code>) y contiene un texto (realmente es el nombre del test) que permite entender claramente la intención del test.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Por un lado indicamos lo que queremos probar y por otro el valor esperado.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>En este caso, quizá sería más apropiado crear dos tests para probar cada uno los límites del rango no permitido (i.e. un test para comprobar que no se aceptn menores que 1 y otro test para comprobar que no se aceptan mayores que 100).</td>
</tr>
</table>
</div>
</li>
<li>
<p><strong>Añadir el servicio de Fizz Buzz al archivo de testing del controlador.</strong> Este paso es muy importante porque NestJS no añade el servicio de Fizz Buzz al archivo de testing del controlador. Tenemos dos opciones: añadir el servicio en el elemento <code>providers</code> o cargar directamente el módulo que definimos al principio, y que ya incorporaba el controlador y el servicio. Esta última será la opción que utilizaremos aquí y que se muestra en el listado de <code>fizzbuzz/fizzbuzz.controller.spec.ts</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="typescript" class="language-typescript hljs">import { Test, TestingModule } from '@nestjs/testing';
import { FizzbuzzController } from './fizzbuzz.controller';
import { FizzbuzzModule } from './fizzbuzz.module';

describe('FizzbuzzController', () =&gt; {
  let controller: FizzbuzzController;

  beforeEach(async () =&gt; {
    const module: TestingModule = await Test.createTestingModule({
      imports: [FizzbuzzModule], <i class="conum" data-value="1"></i><b>(1)</b>
      //controllers: [FizzbuzzController], <i class="conum" data-value="2"></i><b>(2)</b>
    }).compile();

    controller = module.get&lt;FizzbuzzController&gt;(FizzbuzzController);
  });

  it('should be defined', () =&gt; {
    expect(controller).toBeDefined();
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Módulo añadido para incluir controlador y servicio en el test</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Declaración insuficiente (ahora comentada) inicial en la que sólo se especificaba el controlador y no el servicio.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ejecutaremos los tests con <code>npm run test</code>. Este será su resultado:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs"> PASS  src/fizzbuzz/fizzbuzz.controller.spec.ts
 PASS  src/fizzbuzz/fizzbuzz.service.spec.ts
 PASS  src/app.controller.spec.ts

Test Suites: 3 passed, 3 total
Tests:       8 passed, 8 total
Snapshots:   0 total
Time:        2.63 s, estimated 3 s
Ran all test suites.</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si no hubiésemos añadido el servicio o el módulo (que incluye controlador y servicio) en <code>fizzbuzz/fizzbuzz.controller.spec.ts</code>, habríamos obtenido el siguiente error al ejecutar <code>npm run test</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">...
FAIL  src/fizzbuzz/fizzbuzz.controller.spec.ts

● FizzbuzzController › should be defined
    Nest cant resolve dependencies of the FizzbuzzController (?). Please make sure that the argument FizzbuzzService at index [0] is available in the RootTestModule context.

    Potential solutions:
    - If FizzbuzzService is a provider, is it part of the current RootTestModule?
    - If FizzbuzzService is exported from a separate @Module, is that module imported within RootTestModule?
      @Module({
        imports: [ /* the Module containing FizzbuzzService */ ]
      })
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto es una señal de que falta por incluir un servicio en la lista de servicios, bien del módulo, o a nivel de aplicación en <code>app.module.ts</code>. En aras de una mejor organización, optaremos por organizar los controladores y servicios en módulos.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Mostrar los datos de cada test</div>
<div class="paragraph">
<p>De forma predeterminada, los resultados de ejecución de los tests se muestran de forma agregada, perdiéndose los datos de cada test. Esto en ocasiones puede ser útil. Para activarlo, basta con cambiar en <code>package.json</code> la entrada en <code>scripts</code> sustituyendo <code>"test": "jest",</code> por <code>"test": "jest --verbose",</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">....
   "scripts": {
    ....
    "test": "jest --verbose", <i class="conum" data-value="1"></i><b>(1)</b>
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    ....</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Cambio realizado para mostrar los datos de cada test.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>De esta forma, ahora el resultado al ejecutar <code>npm run test</code> será más detallada como se muestra a continuación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="typescript" class="language-typescript hljs"> PASS  src/app.controller.spec.ts
  AppController
    root
      ✓ should return "Hello World!" (14 ms)

 PASS  src/fizzbuzz/fizzbuzz.controller.spec.ts
  FizzbuzzController
    ✓ should be defined (26 ms)

 PASS  src/fizzbuzz/fizzbuzz.service.spec.ts
  FizzbuzzService
    ✓ should be defined (21 ms)
    ✓ should return Fizz when the number is multiple of 3 (2 ms)
    ✓ should return Buzz when the number is multiple of 5 (2 ms)
    ✓ should return FizzBuzz when the number is multiple of 15 (2 ms)
    ✓ should return the number when then number is neither multiple of 3, 5 nor 15 (2 ms)
    ✓ should return nothing when the number is not between 1 and 100 (2 ms)

Test Suites: 3 passed, 3 total
Tests:       8 passed, 8 total
Snapshots:   0 total
Time:        2.575 s, estimated 3 s</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecobertura-de-tests"><a class="anchor" href="#truecobertura-de-tests"></a>4. Cobertura de tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Una medida muy interesante nos la da la cobertura de tests, que ofrece el porcentaje de código que está incluido en los tests. Esto es muy útil porque nos ayuda a dirigir los esfuerzos para crear tests de código que está oculto a los tests y que puede ser una potencial fuente de errores.</p>
</div>
<div class="paragraph">
<p>Podemos conocer la cobertura de nuestros tests con:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ npm run test:cov</code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto, además de ejecutar los tests unitarios nos dará el porcentaje de código testado para cada archivo y a nivel global.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs"> PASS  src/app.controller.spec.ts
  AppController
    root
      ✓ should return "Hello World!" (11 ms)
    Fizzbuzz
      ✓ should return FizzBuzz when the number is multiple of 15 (3 ms)
      ✓ should return Fizz when the number is multiple of 3 (2 ms)
      ✓ should return Buzz when the number is multiple of 5 (2 ms)
      ✓ should return the number when then number is neither multiple of 3, 5 nor 15 (2 ms)
      ✓ should return nothing when the number is not between 1 and 100 (2 ms)


File               % Stmts % Branch  % Funcs % Lines Uncovered Lines
All files            68.57      100    83.33   68.97
 app.controller.ts     100      100      100     100
 app.module.ts           0      100      100       0    1-10
 app.service.ts        100      100      100     100
 main.ts                 0      100        0       0    1-8

Test Suites: 1 passed, 1 total
Tests:       6 passed, 6 total
Snapshots:   0 total
Time:        3.188 s, estimated 4 s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Como resultado también se genera una carpeta <code>coverage/lcov-coverage</code> con ese mismo informe, pero en HTML.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/coverage100.png" alt="coverage100">
</div>
</div>
<div class="paragraph">
<p>Si ahora modificamos los tests y comentamos uno de ellos, por ejemplo el que probaba los múltiplos de 15, y volvemos a ejecutar la cobertura de tests con <code>npm run test:cov</code> veremos que la cobertura de <code>app.service.ts</code> ha bajado.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/coverageParcial.png" alt="coverageParcial">
</div>
</div>
<div class="paragraph">
<p>Si ahora hacemos clic sobre <code>app.service.ts</code> en el informe, nos llevará al archivo y nos dirá las líneas de código que no están tratadas (cubiertas) en ningún test.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/codigoNoProbado.png" alt="codigoNoProbado">
</div>
</div>
<div class="paragraph">
<p>Si anulamos los comentarios del test y volvemos a ejecutar la cobertura de tests todo volverá a estar como antes y ese código ya estará de nuevo cubierto por los tests.</p>
</div>
<div class="sect2">
<h3 id="trueexclusión-de-archivos-de-la-cobertura-de-tests"><a class="anchor" href="#trueexclusión-de-archivos-de-la-cobertura-de-tests"></a>4.1. Exclusión de archivos de la cobertura de tests</h3>
<div class="paragraph">
<p>El porcentaje de cobertura de tests se obtiene teniendo en cuenta todos los archivos de código del proyecto. Sin embargo, es posible ignorar o excluir arvhivos del proceso de obtención de la cobertura. Esto se realiza indicando nombres de archivo o indicando un patrón en el elemento <code>coveragePathIgnorePatterns</code> del elemento <code>jest</code> en el archivo <code>package.json</code>.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, así quedaría el elemento <code>jest</code> en <code>package.json</code> para excluir los archivos de módulo del proceso de estudio de cobertura:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">  "jest": {
    "moduleFileExtensions": [
      "js",
      "json",
      "ts"
    ],
    "rootDir": "src",
    "testRegex": ".*\\.spec\\.ts$",
    "transform": {
      "^.+\\.(t|j)s$": "ts-jest"
    },
    "collectCoverageFrom": [
      "**/*.(t|j)s"
    ],
    "coverageDirectory": "../coverage",
    "coveragePathIgnorePatterns": [".module.ts"], <i class="conum" data-value="1"></i><b>(1)</b>
    "testEnvironment": "node"
  }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ignorar del proceso de cobertura los archivos cuyo nombre termine en <code>.module.ts</code></td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truetests-de-integración"><a class="anchor" href="#truetests-de-integración"></a>5. Tests de integración</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En backend los utilizaremos para testear repositorios. Si hemos seguido el principio de Inversión de dependencias tendremos por un lado una interface con una serie de métodos (p.e. la interface <code>UserRepository</code> con los métodos <code>save</code> y <code>find</code>. Por otro lado, tendremos un conjunto de clases repositorio particulares (p.e. MySQLUserRepository) que implementan esa interface.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Test unitarios: <code>npm run test</code>. Se centra en los módulos y en las clases. El ejemplo básico incorporado comprueba que la llamada al controlador devuelve <code>Hello World!</code>.</p>
</li>
<li>
<p>Test end-to-end: <code>npm run test:e2e</code>. Se centra más en la interacción entre clases y módulos a un nivel más alto, en la línea de cómo interactuarían los usuarios con la aplicación. Con esto automatizaremos la prueba de cada endpoint de la API. Nest usará Supertest para simular las llamadas HTTP.</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">¿Hace falta probarlo todo?</div>
<div class="ulist">
<ul>
<li>
<p>Decidimos qué probar. Alguien podría decir de probarlo todo con una cobertura cercana al 100%.</p>
</li>
<li>
<p>No es necesario. Sólo hay que probar las partes más críticas. Puede que esté entre el 70%-90%</p>
</li>
<li>
<p>Probaremos</p>
<div class="ulist">
<ul>
<li>
<p>Servicios (si hay <code>app.service.ts</code> también)</p>
</li>
<li>
<p>Controladores (si hay <code>app.controller.ts</code> también)</p>
</li>
</ul>
</div>
</li>
<li>
<p>No hace falta probar DTOs, constantes, entidades y módulos.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truebdd"><a class="anchor" href="#truebdd"></a>5.1. BDD</h3>
<div class="ulist">
<ul>
<li>
<p>npm install jest-cucumber --save-dev</p>
</li>
<li>
<p>Crear un archivo <code>tests/jest-bdd.json</code> con este contenido</p>
<div class="listingblock">
<div class="content">
<pre>{
  "moduleFileExtensions": ["js", "json", "ts"],
  "rootDir": ".",
  "testEnvironment": "node",
  "testMatch": [
    "**/*.steps.ts"
  ],
  "transform": {
    "^.+\\.(t|j)s$": "ts-jest"
  }
}</pre>
</div>
</div>
</li>
<li>
<p>En la configuración de jest de package.json:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">...
  "jest": {
    ...
    "testRegex": [".*\\.spec\\.ts$", ".*\\.steps\\.ts$"], <i class="conum" data-value="1"></i><b>(1)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Modificamos la expresión regular para que también tome los <code>*.steps.ts</code></td>
</tr>
</table>
</div>
</li>
<li>
<p>En la configuración scripts de package.json</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">...
  "scripts": {
    ...
    "test:bdd": "jest --config ./test/jest-bdd.json" <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creamos una nueva entrada para ejecutar sólo los tests BDD</td>
</tr>
</table>
</div>
</li>
<li>
<p>Definición de la feature y escenario en test/features/hello.feature</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="txt" class="language-txt hljs">Feature: Logging in

    Scenario: Entering a correct password
        Given I have previously created a password
        When I enter my password correctly
        Then I should be granted access</code></pre>
</div>
</div>
</li>
<li>
<p>Código base de los pasos del test</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">// logging-in.steps.js

import { defineFeature, loadFeature } from 'jest-cucumber';

const feature = loadFeature('test/features/hello.feature'); <i class="conum" data-value="1"></i><b>(1)</b>

defineFeature(feature, (test) =&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
  test('Entering a correct password', ({ given, when, then }) =&gt; {
    given('I have previously created a password', () =&gt; {});

    when('I enter my password correctly', () =&gt; {});

    then('I should be granted access', () =&gt; {});
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Referencia al archivo de la especificación Gherkin</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Código generado automáticamente (Ver nota de información)</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Instalando en Visual Studio Code la extensión <code>Jest-cucumber code generator</code> se activa una opción en el menú emergente que se activa al seleccionar un escenario completo de un archivo <code>.feature</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Otras extesiones interesantes para Visual Studio Code:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cucumber (Gherkin) Full Support</p>
</li>
<li>
<p>Snippets and Syntax Highlight for Gherkin (Cucumber)</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Para ejecutar todos los tests (unitarios y BDD): <code>npm test</code></p>
</li>
<li>
<p>Para ejecutar sólo los tests BDD: <code>npm run test:bdd</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Enlace: <a href="https://github.com/bencompton/jest-cucumber#readme" class="bare">https://github.com/bencompton/jest-cucumber#readme</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecaso-de-uso-catálogo-de-productos"><a class="anchor" href="#truecaso-de-uso-catálogo-de-productos"></a>6. Caso de uso. Catálogo de productos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para ilustrar los tests unitarios y de integración en este tutorial, así como el testing de contoladores, servicios y uso de mocks, vamos a desarrollar un caso de uso sobre un API para un catálogo ficticio de productos. La API ofrecerá los endpoints para las operaciones básicas de crear un producto, obtener el listado de productos, obtener un producto a partir de su id, modificar y eliminar un producto.</p>
</div>
<div class="paragraph">
<p>Para no complicar demasiado el ejemplo pero que también dé juego, de cada producto se guarda:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>id: numérico</p>
</li>
<li>
<p>name: string</p>
</li>
<li>
<p>brand: string</p>
</li>
<li>
<p>category: string</p>
</li>
<li>
<p>price: numérico</p>
</li>
<li>
<p>url: string</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Partimos de un <a href="https://github.com/ualmtorres/testing-product-catalog/tree/base">proyecto creado</a> y disponible en GitHub (rama <code>base</code>). Para más información sobre cómo crear y configurar el proyecto de este caso de uso consultar el <a href="#Anexo. Configuración inicial del proyecto">[Anexo. Configuración inicial del proyecto]</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para clonar la rama <code>base</code>, clonar el repositorio con este comando</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ git clone -b base https://github.com/ualmtorres/testing-product-catalog/tree/base</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Configuración de un servidor MySQL</div>
<div class="paragraph">
<p>Para trabajar localmente con persistencia necesitamos una base de datos a la que conectarnos. Para no tener que complicarnos con instalaciones y no acoplar el desarrollo a nuestro equipo utilizaremos una imagen Docker de MySQL 5.7. Crearemos una base de datos denominada tutorial. Usaremos las cuenta <code>root</code> con el password <code>secret</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ docker run --name testing_mysql -e MYSQL_ROOT_PASSWORD=secret -p 3306:3306 -d mysql:5.7 <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Usaremos el password <code>secret</code> para la cuenta <code>root</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tras unos instantes (algo más si la imagen de MySQL 5.7 no está descargada en el equipo) habrá un contenedor en ejecución con el nombre <code>testing_mysql</code>. Iniciaremos una sesión interactiva para crear una base de datos, a la que denominaremos tutorial</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ docker exec -it testing_mysql bash
root@d0512407a21d:/# mysql -u root -p
Enter password: <i class="conum" data-value="1"></i><b>(1)</b>
...
Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql&gt;
mysql&gt; create database testing; <i class="conum" data-value="2"></i><b>(2)</b>
Query OK, 1 row affected (0.00 sec)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Introducir el password <code>secret</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Crear la base de datos <code>testing</code></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueprimeros-tests"><a class="anchor" href="#trueprimeros-tests"></a>6.1. Primeros tests</h3>
<div class="paragraph">
<p>Comenzamos lanzando los tests sobre el proyecto creado con el comando siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ npm run test</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras unos instantes comprobamos que se han ejecutado tres suites de tests, pero sólo uno se ha ejecutado con éxito, el de <code>src/app.controller.spec.ts</code>. Sin embargo, ni los tests del servicio (<code>src/product/product.service.spec.ts</code>) ni el del controlador (<code>src/product/product.controller.spec.ts</code>) han tenido éxito. En ambos casos nos indica que no están definido su <em>provider</em>.</p>
</div>
<div class="paragraph">
<p>A continuación veremos cómo resolver estos problemas y lo haremos desde el controlador hacia adentro. Primero haremos los tests del controlador y después el del servicio. Finalmente, dedicaremos una sección a realizar los tests de integración.</p>
</div>
</div>
<div class="sect2">
<h3 id="truetests-del-controlador"><a class="anchor" href="#truetests-del-controlador"></a>6.2. Tests del controlador</h3>
<div class="paragraph">
<p>Los tests del controlador fallan porque mientras que en el arranque de la aplicación se cargan los módulos correctamente, al ejecutar los tests se utiliza módulos diferentes de los del entorno de ejecución. Y lo importante, <strong>inicialmente esos módulos no pueden resolver sus dependencias.</strong>. Concretamente, lo que está ocurriendo es que el controlador no puede resolver en el entorno de pruebas su dependencia de <code>ProductService</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
@Controller('product')
export class ProductController {
  constructor(private readonly productService: ProductService) {} <i class="conum" data-value="1"></i><b>(1)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Dependencia respecto a <code>ProductService</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En el código siguiente del test del controlador vemos que dentro de <code>beforeEach</code> se usa la clase <code>Test</code> y un método <code>createTestingModule</code>. Este método toma los mismos argumentos que se usan para crear un módulo (p.e. <code>imports</code>, <code>providers</code>, <code>controllers</code> &#8230;&#8203;). Tras definir el nuevo módulo (el de testing) y llamar al método <code>compile</code> se crea el módulo con sus dependencias similar a los módulos creados para el entorno de ejecución.</p>
</div>
<div class="paragraph">
<p>Archivo <code>src/product/product.controller.spec.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Test, TestingModule } from '@nestjs/testing';
import { ProductController } from './product.controller';
import { ProductService } from './product.service';

describe('ProductController', () =&gt; {
  let controller: ProductController;

  beforeEach(async () =&gt; {
    const module: TestingModule = await Test.createTestingModule({ <i class="conum" data-value="1"></i><b>(1)</b>
      controllers: [ProductController],
      providers: [ProductService], <i class="conum" data-value="2"></i><b>(2)</b>
    }).compile();

    controller = module.get&lt;ProductController&gt;(ProductController); <i class="conum" data-value="3"></i><b>(3)</b>
  });

  it('should be defined', () =&gt; {
    expect(controller).toBeDefined();
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Definición del módulo para el testing del controlador</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Servicio a utilizar</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creación de una instancia del controller</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="trueprimer-paso-evitar-que-falle-el-test"><a class="anchor" href="#trueprimer-paso-evitar-que-falle-el-test"></a>6.2.1. Primer paso. Evitar que falle el test</h4>
<div class="paragraph">
<p>Seguiremos un enfoque progresivo para conseguir que nuestros tests funcionen. Se trata de ayudar a que en primer lugar desaparezcan los errores de las pruebas del controlador. Posteriormente, se irán refinando los tests.</p>
</div>
<div class="paragraph">
<p>El test del controlador falla porque el controlador no es capaz de resolver sus dependencias. Lo que haremos es sustituir el servicio original por un servicio de uso exclusivo en testing. Con esto, conseguiremos probar únicamente el controlador, aislándolo del servicio, que es la premisa de los tests unitarios: probar sólo una cosa en cada test.</p>
</div>
<div class="paragraph">
<p>Pasos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crearemos un objeto <code>mockProductService</code> que sustituya (<em>mockee</em>) al servicio. Inicialmente <code>mockProductService</code> estará vacío. Posteriormente le iremos añadiendo los métodos falseados (<em>mockeados</em>).</p>
</li>
<li>
<p>Construir un módulo de testing que reemplace el servicio original del producto por el mockeado que hemos creado en el paso anterior.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Test, TestingModule } from '@nestjs/testing';
import { ProductController } from './product.controller';
import { ProductService } from './product.service';

describe('ProductController', () =&gt; {
  let controller: ProductController;
  let mockProductService = {}; <i class="conum" data-value="1"></i><b>(1)</b>

  beforeEach(async () =&gt; {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [ProductController],
      providers: [ProductService],
    })
      .overrideProvider(ProductService) <i class="conum" data-value="2"></i><b>(2)</b>
      .useValue(mockProductService) <i class="conum" data-value="3"></i><b>(3)</b>
      .compile(); <i class="conum" data-value="4"></i><b>(4)</b>

    controller = module.get&lt;ProductController&gt;(ProductController);
  });

  it('should be defined', () =&gt; {
    expect(controller).toBeDefined();
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Mock del servicio. Inicialmente vacío para pasar el test</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Servicio que se va a sustituir (mockear)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Servicio que sustituye (mockea) al original</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Construcción del módulo para testing</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lanzaremos ahora los tests, pero nos ceñiremos sólo a los tests del controlador y además lo haremos en modo <code>watch</code>. Así, cada vez que hagamos cambios sobre el código se volverán a ejecutar los tests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">$ npm run test:watch</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pulsaremos <code>p</code> para indicar que sólo se pasen los tests a los archivos que sigan un patrón concreto de nombre de archivo. Introduciremos <code>product.controller</code> como patrón. Con esto, se pasarán los tests sólo al controlador y obtendremos un resultado como el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs"> PASS  src/product/product.controller.spec.ts
  ProductController
    ✓ should be defined (12 ms)

Test Suites: 1 passed, 1 total
Tests:       1 passed, 1 total
Snapshots:   0 total
Time:        4.756 s, estimated 6 s
Ran all test suites matching /product.controller/i.

Watch Usage: Press w to show more.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truesegundo-paso-añadir-tests"><a class="anchor" href="#truesegundo-paso-añadir-tests"></a>6.2.2. Segundo paso. Añadir tests</h4>
<div class="paragraph">
<p>Una vez que hemos configurado el módulo para que el test no falle mediante el mockeo del servicio, vamos a ir creando tests del controlador. Comenzaremos por el de creación de productos añadiendo este test después del test <code>should be defined</code>. Con este nuevo test definimos un nuevo DTO para crear un producto y esperamos que nos devuelva un objeto con un id (da igual el que sea) y el resto de campos coincidirán con los del DTO de creación de producto.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
  it('should create a product', () =&gt; {
    const createProductDto = {
      name: 'the-product',
      brand: 'the-brand',
      category: 'the-category',
      price: 10,
      url: 'http://product.com/the-product',
    };

    expect(controller.create(createProductDto)).toEqual({
      id: expect.any(Number),
      ...createProductDto,
    });
  });
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras guardar los cambios, como estamos en modo <code>watch</code> se volverán a pasar los tests y nos da un fallo: el método create no existe en el mock del servicio, tal y como se muestra a continuación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs"> FAIL  src/product/product.controller.spec.ts
  ProductController
    ✓ should be defined (12 ms)
    ✕ should create a product (4 ms) <i class="conum" data-value="1"></i><b>(1)</b>

  ● ProductController › should create a product

    TypeError: this.productService.create is not a function <i class="conum" data-value="2"></i><b>(2)</b>

      18 |   @Post()
      19 |   create(@Body() createProductDto: CreateProductDto) {
    &gt; 20 |     return this.productService.create(createProductDto); <i class="conum" data-value="3"></i><b>(3)</b>
         |</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>El test no pasa</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>El método <code>create</code> no existe en el mock del servicio (recordamos que estamos en el mockeado)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Línea en la que se provoca el error en el test</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El error se debe a que en la sección anterior creamos el mock del servicio del producto pero lo creamos vacío, sin ningún método. A continuación crearemos la implementación que mockea al método <code>create</code> del servicio. Se limitará a tomar un DTO y devolver un objeto con un <code>id</code> aleatorio y el DTO.</p>
</div>
<div class="paragraph">
<p>Archivo <code>src/product/product.controller.spec.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
describe('ProductController', () =&gt; {
  let controller: ProductController;
  let mockProductService = {
    create: jest.fn((dto) =&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
      return {
        id: Math.random() * (1000 - 1) + 1, <i class="conum" data-value="2"></i><b>(2)</b>
        ...dto, <i class="conum" data-value="3"></i><b>(3)</b>
      };
    }),
  };
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Método <code>create</code> mockeado.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>id aleatorio</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Incorporar el DTO del objeto a crear</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez realizados estos cambios, el test de crear un producto pasa correctamente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs"> PASS  src/product/product.controller.spec.ts
  ProductController
    ✓ should be defined (15 ms)
    ✓ should create a product (3 ms)

Test Suites: 1 passed, 1 total
Tests:       2 passed, 2 total
Snapshots:   0 total
Time:        4.69 s</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Funciones de mock con <code>jest.fn()</code></div>
<div class="paragraph">
<p>Las funciones de mock se usan para inyectar o falsear código durante los tests.
<code>jest.fn()</code> crea una función de mock y opcionalmente puede tomar una implementación como parámetro.</p>
</div>
<div class="paragraph">
<p>Las funciones de mock tienen la propiedad <code>mock</code> que permite, entre otros, conocer los argumentos con los que fue llamada, obtener las veces que fue llamada, y ver el valor de los argumentos en una llamada concreta, por ejemplo, en la tercera vez que fue llamada.</p>
</div>
<div class="paragraph">
<p>También tiene métodos interesantes como los siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>mockReturnValue()</code>: Devuelve el valor que se pase como argumento</p>
</li>
<li>
<p><code>mockResolvedValue()</code>: Devuelve el valor resuelto por una promesa</p>
</li>
<li>
<p><code>mockImplementation()</code>: Acepta una función que es usada como implementación del mock</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>A continuación añadiremos otro test. Por ejemplo, añadiremos el test para actualizar un producto. Comenzaremos creando el test en <code>src/product/product.controller.spec.ts</code>. Lo añadiremos a continuación de los otros tests definidos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
  it('should update a product', () =&gt; {
    const updateProductDto = { <i class="conum" data-value="1"></i><b>(1)</b>
      name: 'new-product',
      brand: 'new-brand',
      category: 'new-category',
      price: 100,
      url: 'http://product.com/the-new-product',
    };
    const productId = 2; <i class="conum" data-value="2"></i><b>(2)</b>


    expect(controller.update(productId, updateProductDto)).toEqual({ <i class="conum" data-value="3"></i><b>(3)</b>
      id: productId,
      ...updateProductDto,
    });
  });
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>DTO con los cambios del producto</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>id del producto a modificar</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Se espera que resulltado de actualizar el producto sea el producto con el id y los datos actualizados</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tras guardar los cambios se volverán a pasar los tests y no pasará este test porque no está definido el método <code>update</code> en el mock del servicio.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs"> FAIL  src/product/product.controller.spec.ts
  ProductController
    ✓ should be defined (12 ms)
    ✓ should create a product (4 ms)
    ✕ should update a product (3 ms)

  ● ProductController › should update a product

    TypeError: this.productService.update is not a function</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para solucionar este problema añadiremos la función <code>update</code> a <code>mockProductService</code>. Con los cambios, quedará así</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
describe('ProductController', () =&gt; {
  let controller: ProductController;
  let mockProductService = {
    create: jest.fn((dto) =&gt; {
      return {
        id: Math.random() * (1000 - 1) + 1,
        ...dto,
      };
    }),
    update: jest.fn((id, dto) =&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
      return {
        id: id,
        ...dto,
      };
    }),
  };
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>update</code> devolverá el nuevo objeto modificado</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tras los cambios, los tests volverán a pasar.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs"> PASS  src/product/product.controller.spec.ts
  ProductController
    ✓ should be defined (12 ms)
    ✓ should create a product (4 ms)
    ✓ should update a product (4 ms)

Test Suites: 1 passed, 1 total
Tests:       3 passed, 3 total
Snapshots:   0 total
Time:        4.542 s, estimated 6 s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, es posible introducir una mejora al test para comprobar que el servicio fue llamado con los argumentos correctos. Esta comprobación va dirigida a conocer si el controlador introduce alguna anomalía al llamar al servicio. Con esto, no sólo nos aseguramos que el controlador hace su trabajo y devuelve los datos correctos, sino que también comprobamos que internamente hace bien su trabajo.</p>
</div>
<div class="paragraph">
<p>Tras los cambios el test quedaría así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
  it('should update a product', () =&gt; {
    const updateProductDto = {
      name: 'new-product',
      brand: 'new-brand',
      category: 'new-category',
      price: 100,
      url: 'http://product.com/the-new-product',
    };
    const productId = 2;


    expect(controller.update(productId, updateProductDto)).toEqual({
      id: productId,
      ...updateProductDto,
    });

    expect(mockProductService.update).toHaveBeenCalledWith(productId, updateProductDto); <i class="conum" data-value="1"></i><b>(1)</b>
  });
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Comprobación de que el servicio ha sido llamado con los argumentos correctos por parte del controlador</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Al guardar, se volverán a pasar los tests y el cambio introducido funcionará correctamente, lo que permitirá validar que el controlador hace bien su trabajo.</p>
</div>
<div class="paragraph">
<p>Ahora se trataría de ir añadiendo los tests que faltan. Para no extender el tutorial, se dejan fuera del tutorial.</p>
</div>
</div>
<div class="sect3">
<h4 id="truetercer-paso-llevar-el-mock-del-servicio-a-una-clase"><a class="anchor" href="#truetercer-paso-llevar-el-mock-del-servicio-a-una-clase"></a>6.2.3. Tercer paso. Llevar el mock del servicio a una clase</h4>
<div class="paragraph">
<p>Hasta ahora hemos mockeado el servicio en la misma clase de testing. Aquí veremos como sacar el mock a una clase aparte. Concretamente se trata de llevar el contenido de los métodos de <code>mockProductService</code> a sendos métodos en una clase nueva.</p>
</div>
<div class="paragraph">
<p>Partimos del servicio mockeado en la propia clase y tenía esta forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="typescript" class="language-typescript hljs">...
  let mockProductService = {
    create: jest.fn((dto) =&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
      return {
        id: Math.random() * (1000 - 1) + 1,
        ...dto,
      };
    }),
    update: jest.fn((id, dto) =&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
      return {
        id: id,
        ...dto,
      };
    }),
  };
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comenzamos generando la clase con el CLI de NestJS</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ nest g class product/ProductServiceMock --no-spec <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Incluimos el parámetro <code>--no-spec</code> para que no cree el archivo de testing</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Esta clase estará inicialmente vacía:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">export class ProductServiceMock {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Crearemos dos métodos <code>create</code> y <code>update</code> en los que incluiremos en código de mocking que ya teníamos renombrando los DTO para darle una mayor semántica. Además, haremos que los métodos devuelvan promesas, tal y como lo hacen en el servicio real.</p>
</div>
<div class="paragraph">
<p>La clase que mockea al servicio ahora quedará así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Product } from './entities/product.entity';
import { CreateProductDto } from './dto/create-product.dto';
import { UpdateProductDto } from './dto/update-product.dto';
export class ProductServiceMock {
  async create(createProductDto: CreateProductDto): Promise&lt;Product&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
    return Promise.resolve({
      id: Math.random() * (1000 - 1) + 1,
      ...createProductDto,
    });
  }

  async update( <i class="conum" data-value="2"></i><b>(2)</b>
    id: number,
    updateProductDto: UpdateProductDto,
  ): Promise&lt;Product&gt; {
    return Promise.resolve({
      id: id,
      ...updateProductDto,
    });
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Método <code>create</code> mockeado</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Método <code>update</code> mockeado</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez que disponemos de la clase que mockea el servicio, haremos los cambios en el archivo de tests del controlador para que use esta clase mockeada en lugar de la variable <code>mockProductService</code>, que es que la que contenía la implementación de los mocks. Hay que hacer varios cambios:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Declarar una variable <code>service</code> de tipo `ProductService</p>
</li>
<li>
<p>Definir un <code>ProductServiceProvider</code> que mockee el provider ProductService</p>
</li>
<li>
<p>Incorporar el <code>ProductServiceProvider</code> a la lista de providers del módulo de testing</p>
</li>
<li>
<p>Usar la clase de mock para construir el módulo de testing</p>
</li>
<li>
<p>Inicializar <code>service</code> al servicio del producto. Como <code>ProductService</code> está mockeado realmente no usará la implementación original</p>
</li>
<li>
<p>Cambiar los tests a asíncronos</p>
</li>
<li>
<p>Añadir <code>await</code> a las llamadas a los métodos del controlador</p>
</li>
<li>
<p>Usar espías de métodos si usamos métodos como <code>toHaveBeenCalledWith</code></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Test, TestingModule } from '@nestjs/testing';
import { ProductController } from './product.controller';
import { ProductService } from './product.service';
import { ProductServiceMock } from './product-service-mock';

describe('ProductController', () =&gt; {
  let controller: ProductController;
  let service: ProductService; <i class="conum" data-value="1"></i><b>(1)</b>

  beforeEach(async () =&gt; {
    const ProductServiceProvider = { <i class="conum" data-value="2"></i><b>(2)</b>
      provide: ProductService,
      useClass: ProductServiceMock,
    };

    const module: TestingModule = await Test.createTestingModule({
      controllers: [ProductController],
      providers: [ProductService, ProductServiceProvider], <i class="conum" data-value="3"></i><b>(3)</b>
    })
      .overrideProvider(ProductService)
      .useClass(ProductServiceMock) <i class="conum" data-value="4"></i><b>(4)</b>
      .compile();

    controller = module.get&lt;ProductController&gt;(ProductController);
    service = module.get&lt;ProductService&gt;(ProductService); <i class="conum" data-value="5"></i><b>(5)</b>
  });

  it('should be defined', () =&gt; {
    expect(controller).toBeDefined();
  });

  it('should create a product', async () =&gt; { <i class="conum" data-value="6"></i><b>(6)</b>
    const createProductDto = {
      name: 'the-product',
      brand: 'the-brand',
      category: 'the-category',
      price: 10,
      url: 'http://product.com/the-product',
    };

    expect(await controller.create(createProductDto)).toEqual({ <i class="conum" data-value="7"></i><b>(7)</b>
      id: expect.any(Number),
      ...createProductDto,
    });
  });

  it('should update a product', async () =&gt; { <i class="conum" data-value="8"></i><b>(8)</b>
    const updateProductDto = {
      name: 'new-product',
      brand: 'new-brand',
      category: 'new-category',
      price: 100,
      url: 'http://product.com/the-new-product',
    };
    const productId = 2;

    expect(await controller.update(productId, updateProductDto)).toEqual({ <i class="conum" data-value="9"></i><b>(9)</b>
      id: productId,
      ...updateProductDto,
    });

    const updateSpy = jest.spyOn(service, 'update'); <i class="conum" data-value="10"></i><b>(10)</b>
    controller.update(productId, updateProductDto); <i class="conum" data-value="11"></i><b>(11)</b>

    expect(updateSpy).toHaveBeenCalledWith(productId, updateProductDto); <i class="conum" data-value="12"></i><b>(12)</b>
    );
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declaración del servicio</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>ProductServiceProvider</code> mockea el provider ProductService</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Se añade <code>ProductServiceProvider</code> como otro provider</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Inicialización del mock a la clase del mock del servicio</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Inicialización del servicio al servicio del producto</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Caso de prueba asíncrono por el <code>await</code> de métodos en el caso de prueba</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Probamos que el producto se crea correctamente y devuelve los valores esperados. La ejecución se hace con <code>await</code></td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Caso de prueba asíncrono por el <code>await</code> de métodos en el caso de prueba</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Probamos que la actualización de un producto se realiza correctamente y devuelve los valores esperados. La ejecución se hace con <code>await</code></td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Crear un espía para el método <code>update</code> en <code>service</code></td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Hacer una actualización de producto</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Probamos que el servicio espiado ha sido llamado por el controlador con los parámetros adecuados</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truetests-del-servicio"><a class="anchor" href="#truetests-del-servicio"></a>6.3. Tests del servicio</h3>
<div class="paragraph">
<p>Una vez creados los tests del controlador procederemos a realizar los tests del servicio. De forma análoga a como hicimos con el controlador, que mockeaba el servicio del que dependía, en los tests del servicio también mockearamos sus dependencias. En el caso del servicio se mockea el repositorio, que es su dependencia.</p>
</div>
<div class="paragraph">
<p>Comenzamos lanzando los tests en modo <code>watch</code>, pero limitados al patrón <code>product.service</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ npm run test:watch</code></pre>
</div>
</div>
<div class="paragraph">
<p>El resultado de los tests nos devolverá que no se pueden resolver las dependencias de <code>ProductService</code>. Esto se debe a que tiene una dependencia con el repositorio y no se puede resolver en el entorno de pruebas.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
@Injectable()
export class ProductService {
  constructor(
    @InjectRepository(Product) private productsRepository: Repository&lt;Product&gt;, <i class="conum" data-value="1"></i><b>(1)</b>
  ) {}
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Dependencia respecto del repositorio</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>De foma análoga a los tests del controlador, en el código siguiente del test del servicio vemos que dentro de <code>beforeEach</code> se usa la clase <code>Test</code> y un método <code>createTestingModule</code>. Este método toma los mismos argumentos que se usan para crear un módulo (p.e. imports, providers, controllers …​). Tras definir el nuevo módulo (el de testing) y llamar al método compile se crea el módulo con sus dependencias similar a los módulos creados para el entorno de ejecución.</p>
</div>
<div class="paragraph">
<p>Archivo <code>src/product/product.service.spec.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
describe('ProductService', () =&gt; {
  let service: ProductService;

  beforeEach(async () =&gt; {
    const module: TestingModule = await Test.createTestingModule({ <i class="conum" data-value="1"></i><b>(1)</b>
      providers: [ProductService], <i class="conum" data-value="2"></i><b>(2)</b>
    }).compile();

    service = module.get&lt;ProductService&gt;(ProductService); <i class="conum" data-value="3"></i><b>(3)</b>
  });
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Definición del módulo para el testing del servicio</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Provider del servicio</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creación de una instancia del servicio</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="trueprimer-paso-evitar-que-falle-el-test-2"><a class="anchor" href="#trueprimer-paso-evitar-que-falle-el-test-2"></a>6.3.1. Primer paso. Evitar que falle el test</h4>
<div class="paragraph">
<p>Al igual que hicimos con el controlador, seguiremos un enfoque progresivo para conseguir que nuestros tests funcionen. Se trata de ayudar a que en primer lugar desaparezcan los errores de las pruebas del servicio. Posteriormente, se irán refinando los tests.</p>
</div>
<div class="paragraph">
<p>El test del servicio falla porque el servicio no es capaz de resolver sus dependencias. Lo que haremos es sustituir el repositorio original por un repositorio de uso exclusivo en testing. Con esto, conseguiremos probar únicamente el servicio, aislándolo del repositorio, que es la premisa de los tests unitarios: probar sólo una cosa en cada test.</p>
</div>
<div class="paragraph">
<p>Pasos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crearemos un objeto <code>mockProductsRepository</code> que sustituya (mockee) al repositorio. Inicialmente <code>mockProductsRepository</code> estará vacío. Posteriormente le iremos añadiendo los métodos falseados (mockeados).</p>
</li>
<li>
<p>Construir un módulo de testing que reemplace el repositorio original del producto por el mockeado que hemos creado en el paso anterior.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Test, TestingModule } from '@nestjs/testing';
import { ProductService } from './product.service';
import { getRepositoryToken } from '@nestjs/typeorm';
import { Product } from './entities/product.entity';

describe('ProductService', () =&gt; {
  let service: ProductService;
  let mockProductsRepository = {}; <i class="conum" data-value="1"></i><b>(1)</b>

  beforeEach(async () =&gt; {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        ProductService,
        { <i class="conum" data-value="2"></i><b>(2)</b>
          provide: getRepositoryToken(Product), <i class="conum" data-value="3"></i><b>(3)</b>
          useValue: mockProductsRepository, <i class="conum" data-value="4"></i><b>(4)</b>
        },
      ],
    }).compile(); <i class="conum" data-value="5"></i><b>(5)</b>

    service = module.get&lt;ProductService&gt;(ProductService);
  });

  it('should be defined', () =&gt; {
    expect(service).toBeDefined();
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Mock del repositorio. Inicialmente vacío para pasar el test</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Nuevo provider</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Repositorio que se va a sustituir (mockear)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Repositorio que sustituye (mockea) al original</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Construcción del módulo para testing</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tras guardar los cambios ahora vemos que ya pasan los tests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs"> PASS  src/product/product.service.spec.ts (5.777 s)
  ProductService
    ✓ should be defined (12 ms)

Test Suites: 1 passed, 1 total
Tests:       1 passed, 1 total
Snapshots:   0 total
Time:        6.522 s</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truesegundo-paso-añadir-tests-2"><a class="anchor" href="#truesegundo-paso-añadir-tests-2"></a>6.3.2. Segundo paso. Añadir tests</h4>
<div class="paragraph">
<p>Una vez que hemos configurado el módulo para que el test no falle mediante el mockeo del repositorio, vamos a ir creando tests del servicio. Comenzaremos por el de creación de productos añadiendo este test después del test <code>should be defined</code>. Con este nuevo test definimos un nuevo DTO para crear un producto y esperamos que nos devuelva un objeto con un id (da igual el que sea) y el resto de campos coincidirán con los del DTO de creación de producto.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
  it('should create a product', async () =&gt; {
    const createProductDto = {
      name: 'the-product',
      brand: 'the-brand',
      category: 'the-category',
      price: 10,
      url: 'http://product.com/the-product',
    };

    expect(await service.create(createProductDto)).toEqual({
      id: expect.any(Number),
      ...createProductDto,
    });
  });
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras guardar los cambios, como estamos en modo <code>watch</code> se volverán a pasar los tests y nos da un fallo: el método <code>create</code> no existe en el mock del repositorio, tal y como se muestra a continuación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs"> FAIL  src/product/product.service.spec.ts
  ProductService
    ✓ should be defined (11 ms)
    ✕ should create a product (3 ms) <i class="conum" data-value="1"></i><b>(1)</b>

  ● ProductService › should create a product

    TypeError: this.productsRepository.save is not a function <i class="conum" data-value="2"></i><b>(2)</b>

      12 |   ) {}
      13 |   async create(createProductDto: CreateProductDto): Promise&lt;Product&gt; {
    &gt; 14 |     return await this.productsRepository.save(createProductDto); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>El test no pasa</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>El método <code>create</code> no existe en el mock del repositorio (recordamos que estamos en el mockeado)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Línea en la que se provoca el error en el test</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El error se debe a que en la sección anterior creamos el mock del repositorio del producto pero lo creamos vacío, sin ningún método. A continuación crearemos la implementación que mockea al método <code>create</code> del repositorio. Se limitará a tomar un DTO y devolver un objeto con un <code>id</code> aleatorio y el DTO.</p>
</div>
<div class="paragraph">
<p>Archivo <code>src/product/product.service.spec.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
describe('ProductService', () =&gt; {
  let service: ProductService;
  let mockProductsRepository = {
    create: jest.fn().mockImplementation((dto) =&gt; { &lt;1&lt;
      return {
        id: Math.random() * (1000 - 1) + 1, <i class="conum" data-value="2"></i><b>(2)</b>
        ...dto, <i class="conum" data-value="3"></i><b>(3)</b>
      };
    }),
  };
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Método create mockeado.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>id</code> aleatorio</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Incorporar el DTO del objeto a crear</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez realizados estos cambios, el test de crear un producto siguen sin pasar correctamente. Nos indica que el método <code>save</code> no está implementado en el mock del repositorio. Esto se debe a que hay una referencia explícita al método <code>save</code> en la implementación del método <code>create</code> en el servicio.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
  async create(createProductDto: CreateProductDto): Promise&lt;Product&gt; {
    return await this.productsRepository.save(createProductDto); <i class="conum" data-value="1"></i><b>(1)</b>
  }
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Referencia al método <code>save</code> del repositorio</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Por tanto, tendremos que añadir la implementación del método <code>save</code> al mock de repositorio, quedando de esta manera:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
describe('ProductService', () =&gt; {
  let service: ProductService;
  let mockProductsRepository = {
    create: jest.fn().mockImplementation((dto) =&gt; {
      return {
        id: Math.random() * (1000 - 1) + 1,
        ...dto,
      };
    }),
    save: jest.fn().mockImplementation((newProduct) =&gt; <i class="conum" data-value="1"></i><b>(1)</b>
      Promise.resolve({ <i class="conum" data-value="2"></i><b>(2)</b>
        id: Math.random() * (1000 - 1) + 1, <i class="conum" data-value="3"></i><b>(3)</b>
        ...newProduct, <i class="conum" data-value="4"></i><b>(4)</b>
      }),
    ),
  };
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Método <code>save</code> mockeado.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>El método devuelve una promesa resuelta</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>id aleatorio</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Incorporar el DTO del objeto a guardar</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez realizados estos cambios, el test de crear un producto pasa correctamente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs"> PASS  src/product/product.service.spec.ts
  ProductService
    ✓ should be defined (11 ms)
    ✓ should create a product (4 ms)

Test Suites: 1 passed, 1 total
Tests:       2 passed, 2 total
Snapshots:   0 total
Time:        4.233 s, estimated 6 s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora se trataría de ir añadiendo los tests que faltan. Para no extender el tutorial, se dejan fuera del tutorial.</p>
</div>
</div>
<div class="sect3">
<h4 id="truetercer-paso-llevar-el-mock-del-repositorio-a-una-clase"><a class="anchor" href="#truetercer-paso-llevar-el-mock-del-repositorio-a-una-clase"></a>6.3.3. Tercer paso. Llevar el mock del repositorio a una clase</h4>
<div class="paragraph">
<p>Hasta ahora hemos mockeado el repositorio en la misma clase de testing. Aquí veremos como sacar el mock a una clase aparte. Concretamente se trata de llevar el contenido de los métodos de mockProductsRepository a sendos métodos en una clase nueva.</p>
</div>
<div class="paragraph">
<p>Partimos del repositorio mockeado en la propia clase y tenía esta forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
  let mockProductsRepository = {
    create: jest.fn().mockImplementation((dto) =&gt; {
      return {
        id: Math.random() * (1000 - 1) + 1,
        ...dto,
      };
    }),
    save: jest.fn().mockImplementation((newProduct) =&gt; <i class="conum" data-value="1"></i><b>(1)</b>
      Promise.resolve({ <i class="conum" data-value="2"></i><b>(2)</b>
        id: Math.random() * (1000 - 1) + 1, <i class="conum" data-value="3"></i><b>(3)</b>
        ...newProduct, <i class="conum" data-value="4"></i><b>(4)</b>
      }),
    ),
  };
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Método para crear productos</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Método para guardar productos</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Comenzamos generando la clase con el CLI de NestJS</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">$ nest g class product/ProductRepositoryMock --no-spec <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Incluimos el parámetro --no-spec para que no cree el archivo de testing</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Esta clase estará inicialmente vacía:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">$ export class ProductRepositoryMock {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Crearemos dos métodos <code>create</code> y <code>save</code> en los que incluiremos en código de mocking que ya teníamos renombrando los DTO para darle una mayor semántica. Además, haremos que los métodos devuelvan promesas, tal y como lo hace el repositorio real.</p>
</div>
<div class="paragraph">
<p>La clase que mockea al repositorio ahora quedará así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="typescript" class="language-typescript hljs">import { Product } from './entities/product.entity';
import { CreateProductDto } from './dto/create-product.dto';
export class ProductRepositoryMock {
  create(createProductDto: CreateProductDto): Promise&lt;Product&gt; {
    return Promise.resolve({
      id: Math.random() * (1000 - 1) + 1,
      ...createProductDto,
    });
  }
  save(product: Product): Promise&lt;Product&gt; {
    return Promise.resolve({
      id: Math.random() * (1000 - 1) + 1,
      ...product,
    });
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Método <code>create</code> mockeado</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Método <code>save</code> mockeado</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez que disponemos de la clase que mockea el repositorio, haremos los cambios en el archivo de tests del servicio para que use esta clase mockeada en lugar de la variable <code>mockProductsRepository</code>, que es la que contenía la implementación de los mocks. Basta con:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Eliminar la variable <code>mockProductsRepository</code></p>
</li>
<li>
<p>Usar la clase de mock para construir el módulo de testing</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La clase de testing quedaría así</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Test, TestingModule } from '@nestjs/testing';
import { ProductService } from './product.service';
import { getRepositoryToken } from '@nestjs/typeorm';
import { Product } from './entities/product.entity';
import { ProductRepositoryMock } from './product-repository-mock';

describe('ProductService', () =&gt; {
  let service: ProductService;

  beforeEach(async () =&gt; {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        ProductService,
        {
          provide: getRepositoryToken(Product),
          useClass: ProductRepositoryMock, <i class="conum" data-value="1"></i><b>(1)</b>
        },
      ],
    }).compile();

    service = module.get&lt;ProductService&gt;(ProductService);
  });

  it('should be defined', () =&gt; {
    expect(service).toBeDefined();
  });

  it('should create a product', async () =&gt; {
    const createProductDto = {
      name: 'the-product',
      brand: 'the-brand',
      category: 'the-category',
      price: 10,
      url: 'http://product.com/the-product',
    };

    expect(await service.create(createProductDto)).toEqual({
      id: expect.any(Number),
      ...createProductDto,
    });
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inicialización del mock a la clase del mock del repositorio</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truetests-end-to-end"><a class="anchor" href="#truetests-end-to-end"></a>6.4. Tests end to end</h3>
<div class="paragraph">
<p>Este tipo de tests se centra más en la interacción entre clases y módulos a un nivel más alto, en la línea de cómo interactuarían los usuarios con la aplicación. Con esto podremos realizar la prueba de cada endpoint de la API. NestJS usa <a href="https://github.com/visionmedia/supertest">Supertest</a> para simular las llamadas HTTP.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para el desarrollo de nuestros tests seguiremos apoyándonos en que NestJS permite la inyección de dependencias de forma que podremos mockear o sustituir componentes fácilmente en el entorno de pruebas.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="trueañadir-script-para-tests-e2e-en-modo-watch"><a class="anchor" href="#trueañadir-script-para-tests-e2e-en-modo-watch"></a>6.4.1. Añadir script para tests e2e en modo <code>watch</code></h4>
<div class="paragraph">
<p>Podemos lanzar las pruebas e2e generadas al crear el proyecto con el CLI de NestJS. En <code>package.json</code> hay un script para ello: <code>test:e2e</code>. Pero antes de lanzar los tests vamos a introducir un script en <code>package.json</code> para que los tests e2e también se ejecuten en modo <code>watch</code>. Añadiremos los cambios al final del elemento <code>scripts</code>:</p>
</div>
<div class="paragraph">
<p>Archivo <code>package.json</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">...
  "scripts": {
    "prebuild": "rimraf dist",
    "build": "nest build",
    "format": "prettier --write \"src/**/*.ts\" \"test/**/*.ts\"",
    "start": "nest start",
    "start:dev": "nest start --watch",
    "start:debug": "nest start --debug --watch",
    "start:prod": "node dist/main",
    "lint": "eslint \"{src,apps,libs,test}/**/*.ts\" --fix",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",
    "test:e2e": "jest --config ./test/jest-e2e.json",
    "test:e2e:watch": "jest --config ./test/jest-e2e.json --watch" <i class="conum" data-value="1"></i><b>(1)</b>
  },
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nueva etiqueta <code>test:e2e:watch</code> para tests e2e en modo <code>watch</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="trueprimer-paso-evitar-que-falle-el-test-3"><a class="anchor" href="#trueprimer-paso-evitar-que-falle-el-test-3"></a>6.4.2. Primer paso. Evitar que falle el test</h4>
<div class="paragraph">
<p>Comenzaremos haciendo una copia de <code>test/app.e2e-spec.ts</code>. La nueva copia se denominará <code>test/product.e2e-spec.ts</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>De forma predeterminada se ejecutarán como tests e2e todos los que incluyan <code>e2e-spec.ts</code> en su nombre de archivo. Esto se configura en el archivo <code>test/jest-e2e.json</code> y queda configurado automáticamente al crear el proyecto con el CLI de NestJS.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ejecutamos los tests e2e con el script <code>test:e2e:watch</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ npm run test:e2e:watch</code></pre>
</div>
</div>
<div class="paragraph">
<p>indicando como patrón <code>product.e2e</code> veremos que se produce un error</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs"> FAIL  test/product.e2e-spec.ts
  ProductController (e2e)
    ✕ / (GET) (170 ms)

  ● ProductController (e2e) › / (GET)

    RepositoryNotFoundError: No repository for "Product" was found. Looks like this entity is not registered in current "default" connection?</code></pre>
</div>
</div>
<div class="paragraph">
<p>El error indica que el módulo de testing creado para la ocasión no es capaz de resolver las dependencias que hay sobre el repositorio de <code>Product</code>. De forma análoga a como hemos hecho con los tests del controlador y del servicio, hay que añadir un mock que permita resolver la dependencia existente. Lo más inmediato es hacer lo mínimo para que el test deje de ejecutarse con errores.</p>
</div>
<div class="paragraph">
<p>Archivo <code>test/product.e2e-spec.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre>import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import * as request from 'supertest';
import { getRepositoryToken } from '@nestjs/typeorm';
import { Product } from '../src/product/entities/product.entity';
import { ProductModule } from '../src/product/product.module';

describe('ProductController (e2e)', () =&gt; {
  let app: INestApplication;
  const mockProductRepository = {
    find: jest.fn(), <i class="conum" data-value="1"></i><b>(1)</b>
  };

  beforeEach(async () =&gt; {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [ProductModule], <i class="conum" data-value="2"></i><b>(2)</b>
    })
      .overrideProvider(getRepositoryToken(Product)) <i class="conum" data-value="3"></i><b>(3)</b>
      .useValue(mockProductRepository) <i class="conum" data-value="4"></i><b>(4)</b>
      .compile(); <i class="conum" data-value="5"></i><b>(5)</b>

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  it('/product (GET)', () =&gt; { <i class="conum" data-value="6"></i><b>(6)</b>
    return request(app.getHttpServer())
      .get('/product')
      .expect(200);
  });
});</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Mock del repositorio. Inicialmente sólo con una función de mock <code>find</code> vacía para pasar el test</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Módulo de producto</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Repositorio que se va a sustituir (mockear)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Repositorio que sustituye (mockea) al original</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Construcción del módulo para testing</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Test a ejecutar. Comprueba que en la ruta raiz (<code>/product</code>) se devuelve un código de estado HTTP de 200</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tras guardar los cambios veremos que pasan los tests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs"> PASS  test/product.e2e-spec.ts
  ProductController (e2e)
    ✓ / (GET) (421 ms)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks.
Test Suites: 1 passed, 1 total
Tests:       1 passed, 1 total
Snapshots:   0 total
Time:        5.513 s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Este test se limita a comprobar que en la ruta <code>/product</code> se devuelve un código de estado HTTP de 200.</p>
</div>
</div>
<div class="sect3">
<h4 id="truesegundo-paso-añadir-tests-3"><a class="anchor" href="#truesegundo-paso-añadir-tests-3"></a>6.4.3. Segundo paso. Añadir tests</h4>
<div class="paragraph">
<p>Comenzamos cambiando el único test existente siguendo los pasos siguientes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Definir un banco de datos de prueba.</p>
</li>
<li>
<p>Implementar la función de mock <code>find</code> para que devuelva el banco de datos de prueba</p>
</li>
<li>
<p>Modificar el test para que compruebe que la llamada al <code>GET</code> devuelve el banco de datos de prueba</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A continuación se muestra el nuevo archivo de pruebas <code>test/product.e2e-spec.ts</code> siguiendo los pasos anteriores:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import * as request from 'supertest';
import { getRepositoryToken } from '@nestjs/typeorm';
import { Product } from '../src/product/entities/product.entity';
import { ProductModule } from '../src/product/product.module';

describe('ProductController (e2e)', () =&gt; {
  let app: INestApplication;

  const mockProducts = [ <i class="conum" data-value="1"></i><b>(1)</b>
    {
      id: 1,
      name: 'the-product-1',
      brand: 'the-brand-1',
      category: 'the-category-1',
      price: 10,
      url: 'http://product.com/the-product-1',
    },
    {
      id: 2,
      name: 'the-product-2',
      brand: 'the-brand-2',
      category: 'the-category-2',
      price: 20,
      url: 'http://product.com/the-product-2',
    },
  ];

  const mockProductRepository = {
        find: jest.fn().mockImplementation(() =&gt; Promise.resolve(mockProducts)), <i class="conum" data-value="2"></i><b>(2)</b>
  };



  beforeEach(async () =&gt; {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [ProductModule],
    })
      .overrideProvider(getRepositoryToken(Product))
      .useValue(mockProductRepository)
      .compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  it('/product (GET)', () =&gt; {
    return request(app.getHttpServer())
      .get('/product')
      .expect(200)
      .expect('Content-Type', /json/) <i class="conum" data-value="3"></i><b>(3)</b>
      .expect(mockProducts); <i class="conum" data-value="4"></i><b>(4)</b>
  });

  afterAll(async () =&gt; { <i class="conum" data-value="5"></i><b>(5)</b>
    await app.close();
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Banco de datos de prueba</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Función mock que devuelve los datos de prueba</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Probamos que la respuesta viene en JSON</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Probamos que la llamada a <code>GET /product</code> devuelve los datos de prueba</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Cerrar la aplicación tras cada test</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tras guardar los cambios, los tests pasan con éxito.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs"> PASS  test/product.e2e-spec.ts
  ProductController (e2e)
    ✓ /product (GET) (396 ms)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Más información sobre el modo de uso y las posibilidades de Supertest en la <a href="https://github.com/visionmedia/supertest">documentación oficial de Supertest</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Continuemos con un nuevo test para probar la creación de productos. Seguiremos estos pasos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Implementar las funciones de mock necesarias para crear un producto (<code>create</code> y <code>save</code>)</p>
</li>
<li>
<p>Implementar el caso de test</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A continuación se muestra cómo queda el archivo de test <code>test/product.e2e-spec.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import * as request from 'supertest';
import { getRepositoryToken } from '@nestjs/typeorm';
import { Product } from '../src/product/entities/product.entity';
import { ProductModule } from '../src/product/product.module';
import { response } from 'express';

describe('ProductController (e2e)', () =&gt; {
  let app: INestApplication;

  const mockProducts = [
    {
      id: 1,
      name: 'the-product-1',
      brand: 'the-brand-1',
      category: 'the-category-1',
      price: 10,
      url: 'http://product.com/the-product-1',
    },
    {
      id: 2,
      name: 'the-product-2',
      brand: 'the-brand-2',
      category: 'the-category-2',
      price: 20,
      url: 'http://product.com/the-product-2',
    },
  ];

  const mockProductRepository = {
    find: jest.fn().mockImplementation(() =&gt; Promise.resolve(mockProducts)),

    create: jest.fn().mockImplementation((dto) =&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
      return {
        id: Math.random() * (1000 - 1) + 1,
        ...dto,
      };
    }),

    save: jest <i class="conum" data-value="2"></i><b>(2)</b>
      .fn()
      .mockImplementation((newProduct) =&gt; Promise.resolve(newProduct)),
  };

  beforeEach(async () =&gt; {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [ProductModule],
    })
      .overrideProvider(getRepositoryToken(Product))
      .useValue(mockProductRepository)
      .compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  it('/product (GET)', () =&gt; {
    return request(app.getHttpServer())
      .get('/product')
      .expect(200)
      .expect('Content-Type', /json/)
      .expect(mockProducts);
  });

  it('/users (POST)', () =&gt; { <i class="conum" data-value="3"></i><b>(3)</b>
    const createProductDto = {
      name: 'the-product',
      brand: 'the-brand',
      category: 'the-category',
      price: 10,
      url: 'http://product.com/the-product',
    };

    return request(app.getHttpServer())
      .post('/product') <i class="conum" data-value="4"></i><b>(4)</b>
      .send(createProductDto) <i class="conum" data-value="5"></i><b>(5)</b>
      .expect(201) <i class="conum" data-value="6"></i><b>(6)</b>
      .then((response) =&gt; { <i class="conum" data-value="7"></i><b>(7)</b>
        expect(response.body).toEqual({
          id: expect.any(Number),
          ...createProductDto,
        });
      });
  });

  afterAll(async () =&gt; {
    await app.close();
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Función de mock <code>create</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Función de mock <code>save</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Test de creación de producto.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>POST</code> en la ruta <code>/product</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Creación del producto con el objeto <code>createProductDto</code> inicializado en el test</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Comprobar que devuelve el código HTTP de producto creado</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Comprobar que el devuelve un objeto con los datos de creación y un <code>id</code> generado</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tras guardar los cambios veremos que los tests pasan.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs"> PASS  test/product.e2e-spec.ts
  ProductController (e2e)
    ✓ /product (GET) (308 ms)
    ✓ /users (POST) (29 ms)

Test Suites: 1 passed, 1 total
Tests:       2 passed, 2 total
Snapshots:   0 total
Time:        5.623 s, estimated 9 s</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecobertura-de-tests-2"><a class="anchor" href="#truecobertura-de-tests-2"></a>6.5. Cobertura de tests</h3>
<div class="paragraph">
<p>Tras realizar tests del controlador, del servicio y de integración cabe preguntarse la cobertura de tests que tenemos y cuáles son las partes del código del proyecto que aún están sin probar. Para ello lanzaremos la cobertura de tests con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ npm run test:cov</code></pre>
</div>
</div>
<div class="paragraph">
<p>El informe de resultados del análisis de cobertura está en la carpeta <code>coverage/lcov-report</code>. Si abrimos <code>index.html</code> accederemos al informe.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/coberturaGeneral.png" alt="coberturaGeneral">
</div>
</div>
<div class="paragraph">
<p>En el informe vemos que la cobertura en el código de la carpeta <code>src</code> es del 43.33% y en la de la carpeta <code>src/product</code> es del 54.9%.</p>
</div>
<div class="paragraph">
<p>Al hacer clic sobre <code>src</code> accederemos al informe de cobertura de esa carpeta y observamos que se está teniendo en cuenta <code>app.module.ts</code> para el análisis de cobertura.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/coberturaSrc.png" alt="coberturaSrc">
</div>
</div>
<div class="paragraph">
<p>Análogamente, al hacer clic sobre <code>src/product</code> accederemos al informe de cobertura de esa carpeta y observamos que se está teniendo en cuenta <code>product.module.ts</code> para el análisis de cobertura.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/coberturaProduct.png" alt="coberturaProduct">
</div>
</div>
<div class="sect3">
<h4 id="trueignorando-los-módulos-para-el-análisis-de-la-cobertura"><a class="anchor" href="#trueignorando-los-módulos-para-el-análisis-de-la-cobertura"></a>6.5.1. Ignorando los módulos para el análisis de la cobertura</h4>
<div class="paragraph">
<p>A continuación excluiremos los archivos de módulo del estudio de cobertura siguiendo la configuración vista en la sección <a href="#trueexclusión-de-archivos-de-la-cobertura-de-tests">Exclusión de archivos de la cobertura de tests</a>. Se trata de incluir en el elemento <code>jest</code> del archivo <code>pagkage.json</code> el código siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">    "coveragePathIgnorePatterns": [
      "module.ts"
    ],</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si volvemos a pasar la cobertura de tests, los porcentajes mejoran ya que se ignoran los archivos de módulo que no tienen ninguna prueba sobre ellos. Ahora la cobertura en el código de la carpeta <code>src</code> la pasado de 43.33% a 59.09% y en la de la carpeta <code>src/product</code> ha pasado de 54.9% a 65.11%.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/coberturaDespuesIgnorar.png" alt="coberturaDespuesIgnorar">
</div>
</div>
<div class="paragraph">
<p>Al entrar en la carpeta <code>src</code> se observa que ya no aparece el archivo <code>app.module.ts</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/CoberturaSrcDespuesDeIgnorar.png" alt="CoberturaSrcDespuesDeIgnorar">
</div>
</div>
</div>
<div class="sect3">
<h4 id="trueanálisis-de-la-cobertura"><a class="anchor" href="#trueanálisis-de-la-cobertura"></a>6.5.2. Análisis de la cobertura</h4>
<div class="paragraph">
<p>La cobertura nos da una indicación muy útil para determinar el código que aún no está probado. Por ejemplo, si en el informe de cobertura de la carpeta <code>coverage/lcov-report</code> analizamos la cobertura de <code>src/product/product.controller.ts</code>, observamos el código que aún está sin probar.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/coberturaProductController.png" alt="coberturaProductController">
</div>
</div>
<div class="paragraph">
<p>La figura nos da una indicación de los métodos en los que deberíamos centrar los esfuerzos de desarrollo de tests. Todo lo que apafece marcado en rojo es código sin tests asociados. Así, deberíamos dirigir el desarrollo de los nuevos tests a los métodos <code>findAll, findOne</code> y <code>remove</code> del controlador.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueanexo-i-configuración-inicial-del-proyecto"><a class="anchor" href="#trueanexo-i-configuración-inicial-del-proyecto"></a>Anexo I. Configuración inicial del proyecto</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para crear ese proyecto recordamos los pasos de su creación. Generaremos también un <em>resource</em> en NestJS para que nos cree el módulo, servicio, controlador, entidad y DTOs. También instalaremos las dependencias de Swagger y TypeORM para MySQL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ nest new testing-product-catalog
$ cd testing-product-catalog
$ nest g resource product <i class="conum" data-value="1"></i><b>(1)</b>
$ npm install --save @nestjs/swagger swagger-ui-express
$ npm install --save typeorm mysql</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>En <em>What transport layer do you use?</em> seleccionamos <code>REST API</code> y en <em>Would you like to generate CRUD entry points?</em> seleccionamos <code>Yes</code></td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="truecreación-de-la-entidad"><a class="anchor" href="#truecreación-de-la-entidad"></a>Creación de la entidad</h3>
<div class="paragraph">
<p>Archivo <code>product.entity.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Column, Entity, PrimaryGeneratedColumn } from 'typeorm';

@Entity()
export class Product {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  name: string;

  @Column()
  brand: string;

  @Column()
  category: string;

  @Column()
  price: number;

  @Column()
  url: string;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueconfiguración-de-typeorm"><a class="anchor" href="#trueconfiguración-de-typeorm"></a>Configuración de TypeORM</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Creación de archivo <code>ormconfig.json</code>. Este archivo se almacena en la raíz del proyecto, junto al <code>package.json</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "type": "mysql",
  "host": "localhost",
  "port": 3306,
  "username": "root",
  "password": "secret",
  "database": "testing",
  "entities": ["dist/**/*.entity.js"],
  "synchronize": true
}</code></pre>
</div>
</div>
</li>
<li>
<p>Configuración de TypeORM en <code>app.module.ts</code></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
@Module({
  imports: [TypeOrmModule.forRoot(), ProductModule], <i class="conum" data-value="1"></i><b>(1)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>El método <code>forRoot()</code> carga la configuración de TypeORM. Al no pasarle nada, la toma del archivo <code>ormconfig.json</code></td>
</tr>
</table>
</div>
</li>
<li>
<p>Registro de repositorio <code>Product</code> en <code>product/product.module.ts</code></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
@Module({
  imports: [TypeOrmModule.forFeature([Product])],
...</code></pre>
</div>
</div>
</li>
<li>
<p>Creación del constructor del servicio en <code>product/product.service.ts</code> para inyectar el repositorio de <code>Product</code></p>
<div class="listingblock">
<div class="content">
<pre>...
@Injectable()
export class ProductService {
  constructor(
    @InjectRepository(Product) private productsRepository: Repository&lt;Product&gt;,
  ) {}
...</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="trueconfiguración-de-swagger"><a class="anchor" href="#trueconfiguración-de-swagger"></a>Configuración de Swagger</h3>
<div class="paragraph">
<p>En <code>main.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { NestFactory } from '@nestjs/core';
import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // Configurar títulos de documnentación
  const options = new DocumentBuilder()
    .setTitle('Product catalog REST API')
    .setDescription('API REST de Product catalog')
    .setVersion('1.0')
    .build();
  const document = SwaggerModule.createDocument(app, options);

  // La ruta en que se sirve la documentación
  SwaggerModule.setup('docs', app, document);

  await app.listen(3000);
}
bootstrap();</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truedtos"><a class="anchor" href="#truedtos"></a>DTOs</h3>
<div class="paragraph">
<p>DTO <code>product/dto/create-product.dto.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">export class CreateProductDto {
import { ApiProperty } from '@nestjs/swagger';

export class CreateProductDto {
  @ApiProperty({ example: 'the-product' })
  readonly name: string;

  @ApiProperty({ example: 'the-brand' })
  readonly brand: string;

  @ApiProperty({ example: 'the-category' })
  readonly category: string;

  @ApiProperty({ example: 99 })
  readonly price: number;

  @ApiProperty({ example: 'http://product.com/the-product' })
  readonly url: string;
}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>DTO <code>product/dto/update-product.dto.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { CreateProductDto } from './create-product.dto';

export class UpdateProductDto extends CreateProductDto {}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueimplementación-de-los-métodos-del-servicio"><a class="anchor" href="#trueimplementación-de-los-métodos-del-servicio"></a>Implementación de los métodos del servicio</h3>
<div class="paragraph">
<p>Archivo <code>product/product.service.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Injectable } from '@nestjs/common';
import { CreateProductDto } from './dto/create-product.dto';
import { UpdateProductDto } from './dto/update-product.dto';
import { InjectRepository } from '@nestjs/typeorm';
import { Product } from './entities/product.entity';
import { Repository } from 'typeorm';

@Injectable()
export class ProductService {
  constructor(
    @InjectRepository(Product) private productsRepository: Repository&lt;Product&gt;,
  ) {}
  async create(createProductDto: CreateProductDto): Promise&lt;Product&gt; {
    return await this.productsRepository.save(createProductDto);
  }

  async findAll(): Promise&lt;Product[]&gt; {
    return await this.productsRepository.find();
  }

  async findOne(id: number): Promise&lt;Product&gt; {
    return await this.productsRepository.findOne(id);
  }

  async update(
    id: number,
    updateProductDto: UpdateProductDto,
  ): Promise&lt;Product&gt; {
    let toUpdate = await this.productsRepository.findOne(id);
    let updated = Object.assign(toUpdate, updateProductDto);

    return await this.productsRepository.save(updated);
  }

  async remove(id: number): Promise&lt;Product&gt; {
    let toRemove = await this.productsRepository.findOne(id);
    let removedProducts = await this.productsRepository.remove(
      new Array(toRemove),
    );

    return removedProducts[0];
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueadaptación-de-los-parámetros-del-controlador"><a class="anchor" href="#trueadaptación-de-los-parámetros-del-controlador"></a>Adaptación de los parámetros del controlador</h3>
<div class="paragraph">
<p>El CLI de NestJS genera los endpoints usando el <code>id</code> de tipo <code>string</code>. Sin embargo, como en la entidad <code>Product</code> hemos definido el <code>id</code> de tipo <code>number</code> hay que cambiar el tipo del parámetro <code>id</code> en los métodos del controlador.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
} from '@nestjs/common';
import { ProductService } from './product.service';
import { CreateProductDto } from './dto/create-product.dto';
import { UpdateProductDto } from './dto/update-product.dto';

@Controller('product')
export class ProductController {
  constructor(private readonly productService: ProductService) {}

  @Post()
  create(@Body() createProductDto: CreateProductDto) {
    return this.productService.create(createProductDto);
  }

  @Get()
  findAll() {
    return this.productService.findAll();
  }

  @Get(':id')
  findOne(@Param('id') id: number) {
    return this.productService.findOne(id);
  }

  @Patch(':id')
  update(@Param('id') id: number, @Body() updateProductDto: UpdateProductDto) {
    return this.productService.update(id, updateProductDto);
  }

  @Delete(':id')
  remove(@Param('id') id: number) {
    return this.productService.remove(id);
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-11-12 21:51:49 +0100
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>